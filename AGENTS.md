# Ma-Dai-Shi Agent Instructions

## Project Overview
Ma-Dai-Shi is a quasi-linear indistinguishability obfuscation (iO) implementation with a honeypot demo showcasing zkSNARK verification on Ethereum.

## Build Commands

### Rust (Core Library)
```bash
cargo build          # Build library
cargo test           # Run tests
cargo check          # Type check
```

### Noir Circuits (honeypot-demo/circuits-medium/)
```bash
nargo compile        # Compile circuit
bb write_vk -b target/honeypot_medium.json  # Generate verification key
bb contract -k target/vk -o HoneypotVerifier.sol  # Generate Solidity verifier
```

### Solidity Contracts (honeypot-demo/contracts/)
```bash
forge build          # Compile contracts
forge test           # Run tests
```

### Web App (honeypot-demo/web/)
```bash
npm install          # Install dependencies
npm run dev          # Start dev server (port 8080)
npm run build        # Production build
```

## Deployed Contracts (Tenderly Virtual Testnet)

- **RPC URL**: `https://virtual.sepolia.eu.rpc.tenderly.co/4d623b04-35fd-4fe7-8e76-6c2757f265ad`
- **Chain ID**: 73571
- **HonkVerifier**: `0x4cD6BA54F81213d27D650C750e27c234d8a3042B`
- **SeedPhraseHoneypot**: `0xCBf7fe54F7aEe6eD748e47094BD6E7286F3af276`
- **Program Hash**: `0x88` (136 = simple_hash for 16 identity matrices)

## HonkVerifier Size Optimization

The UltraHonk verifier generated by `bb contract` can exceed the 24KB EVM contract size limit.

### Solution: Compiler Settings
In `foundry.toml`:
```toml
optimizer = true
optimizer_runs = 1    # Optimize for size, not gas
via_ir = false        # via_ir causes stack-too-deep errors with HonkVerifier
```

This reduced our verifier from 30KB to **20.6KB**.

### Alternative: External Libraries (yolo repo approach)
For larger circuits, deploy `ZKTranscriptLib` and `HonkVerificationKey` as separate library contracts and link them at deployment. See `igor53627/yolo` for reference.

### Tenderly-Specific Commands
```bash
# Fund an account
curl -X POST "$RPC" -d '{"jsonrpc":"2.0","id":1,"method":"tenderly_setBalance","params":["0xADDRESS","0x56BC75E2D63100000"]}'

# Deploy with value (use cast send, not forge create)
cast send --rpc-url "$RPC" --private-key "$PK" --value 0.1ether --create "$BYTECODE"
```

## Code Style
- Rust: Follow existing patterns in `src/`
- Solidity: Foundry conventions
- TypeScript/JS: ES modules, viem for Ethereum

## Testing
- Rust tests: `cargo test`
- Noir circuits: `nargo test`
- Solidity: `forge test`
- Web: Manual testing via dev server
